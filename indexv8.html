<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Phone Order Manager (v6)</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React & Babel (single-file dev) -->
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.22.5/babel.min.js"></script>
  
  <!-- jsPDF (for PDF receipts) -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>


  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>

  <style>
    .fade-down { animation: fadeDown .45s ease-out forwards; }
    @keyframes fadeDown { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(18px); } }
    .slide-up { animation: slideUp .45s ease-out forwards; }
    @keyframes slideUp { from { transform: translateY(0); } to { transform: translateY(-100%); } }
    .fade-in { animation: fadeIn .28s ease-in forwards; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .scale-transition { transition: transform .18s ease; }
    .scale-transition:hover { transform: scale(1.04); }
    .card-shadow { box-shadow: 0 8px 18px -8px rgba(0,0,0,0.35); }
    .max-w-xl { max-width: 36rem; }
    .max-w-3xl { max-width: 48rem; }
    .filter-badge { padding: .15rem .5rem; border-radius: .45rem; font-size: .8rem; }
  </style>
</head>
<body class="dark bg-gradient-to-br from-slate-800 to-slate-700 min-h-screen">

<div id="root"></div>

<script type="text/babel">
const { useState, useEffect, useMemo } = React;

/* ---------- Helpers ---------- */
const formatCurrency = (pence) => 'Â£' + (pence/100).toFixed(2);
const uid = () => Date.now().toString(36) + Math.random().toString(36).slice(2,8);

/* ---------- Default products (temporary) ---------- */
const DEFAULT_PRODUCTS = [
  { id: 'cod', name: 'Cod & Chips', pricePence: 750, tags: ['mains'] },
  { id: 'sausage', name: 'Sausage & Chips', pricePence: 650, tags: ['mains'] },
  { id: 'scampi', name: 'Scampi & Chips', pricePence: 800, tags: ['mains'] },
  { id: 'cheesy', name: 'Cheesy Chips', pricePence: 450, tags: ['sides'] },
  { id: 'curry', name: 'Curry Sauce', pricePence: 120, tags: ['extras'] },
  { id: 'cola', name: 'Coke (330ml)', pricePence: 150, tags: ['drinks'] },
  { id: 'pepsi', name: 'Pepsi (330ml)', pricePence: 150, tags: ['drinks'] },
  { id: 'water', name: 'Bottled Water', pricePence: 120, tags: ['drinks'] },
];

/* ---------- Local Storage Keys ---------- */
const LS = {
  ORDERS: 'phone_orders_v6',
  THEME: 'phone_orders_theme_v6',
  PRODUCTS: 'phone_orders_products_v6',
};

/* ---------- Storage helpers ---------- */
const load = (key, fallback) => {
  try { const v = localStorage.getItem(key); return v ? JSON.parse(v) : fallback; } catch(e) { return fallback; }
};
const save = (key, data) => { try { localStorage.setItem(key, JSON.stringify(data)); } catch(e){} };

/* ---------- UI components ---------- */
function Toast({ open, text, actionLabel, onAction }) {
  if (!open) return null;
  return (
    <div className="fixed bottom-8 left-1/2 -translate-x-1/2 z-50">
      <div className="px-4 py-3 rounded-xl card-shadow bg-slate-800 text-slate-100 flex items-center gap-4">
        <div>{text}</div>
        {onAction && <button onClick={onAction} className="px-3 py-1 rounded bg-slate-700 text-sm">{actionLabel || 'Undo'}</button>}
      </div>
    </div>
  );
}

function Modal({ open, title, onClose, children, wide=false }) {
  if (!open) return null;
  return (
    <div className="fixed inset-0 bg-black/50 z-40 flex items-center justify-center p-4">
      <div className={`bg-white dark:bg-slate-800 rounded-2xl overflow-hidden w-full ${wide ? 'max-w-3xl' : 'max-w-xl'} card-shadow`}>
        <div className="px-5 py-3 border-b border-slate-200/10 flex justify-between items-center">
          <h3 className="font-semibold text-slate-900 dark:text-slate-100">{title}</h3>
          <button onClick={onClose} className="text-slate-500 hover:text-slate-300"><i className="fas fa-times"></i></button>
        </div>
        <div className="p-5 text-slate-900 dark:text-slate-100">{children}</div>
      </div>
    </div>
  );
}

/* ---------- Main App ---------- */
function App() {
  /* theme */
  const [isDark, setIsDark] = useState(() => load(LS.THEME, true));
  useEffect(()=>{ save(LS.THEME, isDark); document.body.className = isDark ? 'dark bg-gradient-to-br from-slate-800 to-slate-700 min-h-screen' : 'bg-[#f1f2f4] min-h-screen'; }, [isDark]);

  /* products */
  const [products, setProducts] = useState(() => load(LS.PRODUCTS, DEFAULT_PRODUCTS));
  useEffect(()=> save(LS.PRODUCTS, products), [products]);

  /* orders */
  const [orders, setOrders] = useState(() => load(LS.ORDERS, []));
  useEffect(()=> save(LS.ORDERS, orders), [orders]);

  /* active order */
  const [orderType, setOrderType] = useState(null); // 'collection' or 'delivery'
  const [orderItems, setOrderItems] = useState([]);
  const [orderTime, setOrderTime] = useState(''); // "HH:MM"
  const [customer, setCustomer] = useState({ name:'', address:'', postcode:'', phone:'' });
  const [step, setStep] = useState(1);

  /* editing */
  const [editingOrderId, setEditingOrderId] = useState(null);
  const [editingPart, setEditingPart] = useState(null); // 'items' | 'time' | 'customer'
  const [editingBannerCustomer, setEditingBannerCustomer] = useState('');

  /* UI */
  const [showItemModal, setShowItemModal] = useState(null);
  const [toast, setToast] = useState({ open:false, text:'', action:null });
  const [search, setSearch] = useState('');
  const [filterPanelOpen, setFilterPanelOpen] = useState(false);
  const [selectedTags, setSelectedTags] = useState([]);
  const [showCompleted, setShowCompleted] = useState(false);
  const [resetModalOpen, setResetModalOpen] = useState(false);

  /* new-order confirmation modal */
  const [newOrderConfirmOpen, setNewOrderConfirmOpen] = useState(false);
  const [pendingNewType, setPendingNewType] = useState(null); // temp store type when modal shows

  /* edit-choice modal */
  const [editChoiceModalOpen, setEditChoiceModalOpen] = useState(false);
  const [viewModalOpen, setViewModalOpen] = useState(false);
const [viewingOrder, setViewingOrder] = useState(null);


  /* derived totals */
  const totalItems = useMemo(()=> orderItems.reduce((s,i)=>s + i.qty, 0), [orderItems]);
  const grandTotalPence = useMemo(()=> orderItems.reduce((s,i)=> s + i.qty * i.pricePence, 0), [orderItems]);

  /* helpers */
  const showToast = (text, action=null) => {
    setToast({ open:true, text, action });
    if (!action) setTimeout(()=> setToast({ open:false, text:'', action:null }), 3500);
  };

  /* product filters */
  const toggleTag = (tag) => setSelectedTags(prev => prev.includes(tag) ? prev.filter(t=>t!==tag) : [...prev, tag]);
  const clearFilters = () => setSelectedTags([]);

  const filteredProducts = useMemo(()=> {
    const q = search.trim().toLowerCase();
    return products.filter(p => {
      const qMatch = !q || p.name.toLowerCase().includes(q);
      const tagMatch = selectedTags.length === 0 || (p.tags || []).some(t => selectedTags.includes(t));
      return qMatch && tagMatch;
    });
  }, [products, search, selectedTags]);

  /* item ops */
  const addOrUpdateItem = (product, qty) => {
    if (!product || qty <= 0) return;
    setOrderItems(prev => {
      const found = prev.find(i => i.productId === product.id);
      if (found) return prev.map(i => i.productId === product.id ? { ...i, qty: i.qty + qty } : i);
      return [...prev, { productId: product.id, name: product.name, pricePence: product.pricePence, qty }];
    });
    showToast(`${product.name} added x${qty}`);
  };

  const updateQty = (productId, qty) => {
    if (qty <= 0) { removeItem(productId); return; }
    setOrderItems(prev => prev.map(i => i.productId === productId ? { ...i, qty } : i));
    showToast('Quantity updated');
  };

  const removeItem = (productId) => {
    const prod = orderItems.find(i => i.productId === productId);
    setOrderItems(prev => prev.filter(i => i.productId !== productId));
    if (prod) showToast(`${prod.name} removed`);
  };

  const clearActiveOrder = () => {
    setOrderType(null);
    setOrderItems([]);
    setOrderTime('');
    setCustomer({ name:'', address:'', postcode:'', phone:'' });
    setEditingOrderId(null);
    setEditingPart(null);
    setEditingBannerCustomer('');
    setStep(1);
  };

  /* check if there is active unsaved order data */
  const currentOrderHasData = () => {
    if (orderItems.length > 0) return true;
    if (orderTime) return true;
    if (customer.name || customer.address || customer.postcode || customer.phone) return true;
    return false;
  };

  /* handle starting new order (with confirmation when needed) */
  const handleStartNew = (type) => {
    if (currentOrderHasData()) {
      setPendingNewType(type);
      setNewOrderConfirmOpen(true);
    } else {
      clearActiveOrder();
      setOrderType(type);
      setStep(2);
    }
  };
  const confirmStartNew = () => {
    clearActiveOrder();
    setOrderType(pendingNewType);
    setPendingNewType(null);
    setNewOrderConfirmOpen(false);
    showToast('New order started');
    setStep(2);
  };
  const cancelStartNew = () => {
    setPendingNewType(null);
    setNewOrderConfirmOpen(false);
  };

  /* saving new order (not editing) */
  const saveOrder = () => {
    if (!orderTime) { showToast('Please choose a time'); return; }
    if (!customer.name.trim()) { showToast('Customer name required'); return; }
    if (orderType === 'delivery' && (!customer.address.trim() || !customer.postcode.trim())) { showToast('Delivery address and postcode required'); return; }

    const orderObj = {
      id: uid(),
      type: orderType,
      items: orderItems.map(i => ({ ...i })),
      time: orderTime,
      customer: { ...customer },
      totalPence: grandTotalPence,
      createdAt: new Date().toISOString(),
      status: 'pending'
    };
    setOrders(prev => [orderObj, ...prev]);
    showToast('Order saved');
    clearActiveOrder();
  };

  /* mark complete / reopen / delete */
  const markComplete = (id) => { setOrders(prev => prev.map(o => o.id === id ? { ...o, status:'completed' } : o)); showToast('Order marked complete'); };
  const reopenOrder = (id) => { setOrders(prev => prev.map(o => o.id === id ? { ...o, status:'pending' } : o)); showToast('Order reopened'); };
  const deleteOrder = (id) => { setOrders(prev => prev.filter(o => o.id !== id)); showToast('Order deleted'); };

  /* reset day modal */
  const confirmResetDay = () => setResetModalOpen(true);
  const doResetDay = () => { setOrders([]); setResetModalOpen(false); showToast('Day reset â€” all orders cleared'); };

/* view flow - open view modal with print option */
const beginView = (orderId) => {
  const ord = orders.find(o => o.id === orderId);
  if (!ord) { showToast('Order not found'); return; }
  setViewingOrder(ord);
  setViewModalOpen(true);
};

  /* edit flow - open choice modal */
  const beginEdit = (orderId) => {
    const ord = orders.find(o => o.id === orderId);
    if (!ord) { showToast('Order not found'); return; }
    if (ord.status !== 'pending') { showToast('Only pending orders can be edited'); return; }
    setEditingOrderId(orderId);
    setEditChoiceModalOpen(true);
  };

  /* choose part to edit */
  const chooseEditPart = (part) => {
    const ord = orders.find(o => o.id === editingOrderId);
    if (!ord) { setEditChoiceModalOpen(false); setEditingOrderId(null); showToast('Order not found'); return; }

    // load active form with order values
    setOrderType(ord.type);
    setOrderItems(ord.items.map(i => ({ ...i })));
    setOrderTime(ord.time || '');
    setCustomer({ ...ord.customer });

    setEditingPart(part);
    setEditingBannerCustomer(ord.customer.name || '');
    // jump to the step for that part
    if (part === 'items') setStep(2);
    if (part === 'time') setStep(3);
    if (part === 'customer') setStep(4);

    setEditChoiceModalOpen(false);
    showToast(`Editing ${part} for ${ord.customer.name}`);
  };

  /* done editing - save only the edited part back to the specific order */
const doneEditing = () => {
  if (!editingOrderId) { showToast('No order in edit mode'); return; }
  let updatedOrder = null;
  setOrders(prev => prev.map(o => {
    if (o.id !== editingOrderId) return o;
    const updated = { ...o };
    if (editingPart === 'items') {
      updated.items = orderItems.map(i => ({ ...i }));
      updated.totalPence = orderItems.reduce((s,i) => s + i.qty * i.pricePence, 0);
    } else if (editingPart === 'time') {
      if (!orderTime) { showToast('Please choose a time before finishing'); return o; }
      updated.time = orderTime;
    } else if (editingPart === 'customer') {
      if (!customer.name.trim()) { showToast('Customer name required'); return o; }
      if (o.type === 'delivery' && (!customer.address.trim() || !customer.postcode.trim())) { showToast('Address & postcode required'); return o; }
      updated.customer = { ...customer };
    }
    updatedOrder = updated;
    return updated;
  }));

  showToast(`Changes saved for ${editingBannerCustomer || 'order'}`);

  // auto-generate a PDF receipt for the updated order
  if (updatedOrder) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({
      orientation: 'portrait',
      unit: 'mm',
      format: [58, 120],
    });

    let y = 10;
    const line = (text, size = 10, bold = false) => {
      doc.setFontSize(size);
      doc.setFont('helvetica', bold ? 'bold' : 'normal');
      doc.text(text, 5, y);
      y += 5;
    };

    line('ðŸŸ Fish & Chips Shop', 12, true);
    line('------------------------------');
    line(`Order Type: ${updatedOrder.type}`);
    line(`Time: ${updatedOrder.time}`);
    line(`Customer: ${updatedOrder.customer.name}`);
    if (updatedOrder.type === 'delivery') {
      line(`${updatedOrder.customer.address}`);
      line(`${updatedOrder.customer.postcode}`);
      if (updatedOrder.customer.phone) line(`Phone: ${updatedOrder.customer.phone}`);
    }
    line('------------------------------');

    updatedOrder.items.forEach(it => {
      line(`${it.name} x${it.qty}`);
      line(`Â£${(it.pricePence * it.qty / 100).toFixed(2)}`);
    });

    line('------------------------------');
    line(`Total: Â£${(updatedOrder.totalPence / 100).toFixed(2)}`, 12, true);
    line('------------------------------');
    line(new Date().toLocaleString(), 8);
    line('Thank you!', 10, true);

    doc.save(`order_${updatedOrder.customer.name || 'customer'}.pdf`);
  }

  // exit edit mode
  setEditingPart(null);
  setEditingOrderId(null);
  setEditingBannerCustomer('');
  clearActiveOrder();
};

/* auto-hide toast */
useEffect(() => {
  if (toast.open && !toast.action) {
    const t = setTimeout(() => setToast({ open: false, text: '', action: null }), 3500);
    return () => clearTimeout(t);
  }
}, [toast]);

/* ---------- Render ---------- */
return (
  <div className="min-h-screen pb-16">
    {/* Editing banner */}
    {editingPart && (
      <div className="w-full bg-yellow-400 text-slate-900 py-2">
        <div className="max-w-[92vw] mx-auto text-center font-semibold">
          ðŸŸ¡ Editing order for {editingBannerCustomer || 'customer'} â€” make changes, then press <span className="underline">Done Editing</span>
        </div>
      </div>
    )}


      <header className="max-w-[92vw] mx-auto pt-6">
        <div className="flex items-start justify-between gap-4">
          <div>
            <h1 className={`text-2xl md:text-3xl font-extrabold ${isDark ? 'text-white' : 'text-slate-800'}`}>Phone Order Manager</h1>
            <p className={`${isDark ? 'text-slate-200/80' : 'text-slate-700/80'} mt-1`}>Phone order flow â€” collection & delivery</p>
          </div>

          <div className="flex items-center gap-2">
            <button onClick={() => setIsDark(d=>!d)} className={`w-10 h-10 rounded-full ${isDark ? 'bg-emerald-600' : 'bg-emerald-500'} text-white flex items-center justify-center scale-transition`}>
              <i className={`fas ${isDark ? 'fa-moon' : 'fa-sun'}`}></i>
            </button>
          </div>
        </div>

        <div className="mt-4 flex gap-3">
          <button onClick={() => handleStartNew('collection')}
                  className={`flex-1 py-3 rounded-xl text-white font-semibold ${orderType === 'collection' ? 'bg-emerald-500' : 'bg-emerald-600/90 hover:bg-emerald-500'} card-shadow`}>
            Collection
          </button>
          <button onClick={() => handleStartNew('delivery')}
                  className={`flex-1 py-3 rounded-xl text-white font-semibold ${orderType === 'delivery' ? 'bg-blue-500' : 'bg-blue-600/90 hover:bg-blue-500'} card-shadow`}>
            Delivery
          </button>
        </div>
      </header>

      <main className="max-w-[92vw] mx-auto mt-6 grid md:grid-cols-3 gap-6">
        {/* LEFT: Steps / form */}
        <section className="md:col-span-2 space-y-4">
          <div className={`${isDark ? 'bg-slate-800' : 'bg-white'} rounded-2xl p-4 card-shadow`}>

            <div className="flex items-center justify-between">
              <div>
                <div className={`text-sm ${isDark ? 'text-slate-300' : 'text-slate-600'}`}>Step {step} of 5</div>
                <h2 className={`text-lg font-semibold ${isDark ? 'text-white' : 'text-slate-800'}`}>
                  {step === 1 && 'Confirm Type'}
                  {step === 2 && 'Add Items'}
                  {step === 3 && 'Choose Time'}
                  {step === 4 && 'Customer Details'}
                  {step === 5 && 'Review & Confirm'}
                </h2>
              </div>
              <div className={`text-sm ${isDark ? 'text-slate-300' : 'text-slate-600'}`}>
                Items: <span className="font-medium">{totalItems}</span> â€¢ Total: <span className="font-medium">{formatCurrency(grandTotalPence)}</span>
              </div>
            </div>

            <div className="mt-4">
              {/* Step 1 */}
              {step === 1 && (
                <div className={`p-4 rounded-lg ${isDark ? 'bg-slate-700/40' : 'bg-slate-100'} text-slate-200`}>Choose Collection or Delivery at the top to start a new order.</div>
              )}

              {/* Step 2: Items */}
              {step === 2 && (
                <div className="mt-3">
                  <div className="flex items-center gap-3 mb-3">
                    <input placeholder="Search products..." value={search} onChange={(e)=>setSearch(e.target.value)} className={`flex-1 px-3 py-2 rounded-lg ${isDark ? 'bg-slate-700 text-white' : 'bg-white text-slate-800'} border ${isDark ? 'border-slate-600' : 'border-slate-200'}`} />
                    <button onClick={()=>setFilterPanelOpen(p=>!p)} className={`px-3 py-2 rounded-lg ${isDark ? 'bg-slate-700 text-white' : 'bg-slate-200 text-slate-800'}`}><i className="fas fa-filter"></i></button>
                  </div>

                  {/* inline filter panel */}
                  {filterPanelOpen && (
                    <div className={`mb-3 p-3 rounded-md ${isDark ? 'bg-slate-700/40' : 'bg-slate-100'}`}>
                      <div className="flex flex-wrap items-center gap-2">
                        <button onClick={() => { clearFilters(); setFilterPanelOpen(false); }} className="px-3 py-1 rounded bg-slate-200 text-slate-800 text-sm">All</button>
                        {['mains','sides','drinks','extras'].map(tag => (
                          <button key={tag} onClick={() => toggleTag(tag)} className={`${selectedTags.includes(tag) ? 'bg-indigo-600 text-white' : (isDark ? 'bg-slate-700 text-white' : 'bg-white text-slate-800')} px-3 py-1 rounded text-sm`}>{tag}</button>
                        ))}
                        <button onClick={() => clearFilters()} className="ml-auto text-sm text-rose-600">Clear</button>
                      </div>
                    </div>
                  )}

                  <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
                    {filteredProducts.map(prod => (
                      <div key={prod.id} className={`${isDark ? 'bg-slate-700' : 'bg-white'} rounded-xl p-3 flex items-center gap-3 cursor-pointer card-shadow hover:scale-105`} onClick={() => setShowItemModal(prod)}>
                        <div className="w-12 h-12 rounded-md bg-slate-600 flex items-center justify-center text-sm font-semibold text-white">{prod.name.split(' ').slice(0,2).map(w=>w[0]).join('')}</div>
                        <div className="flex-1">
                          <div className={`${isDark ? 'text-white' : 'text-slate-800'} font-semibold`}>{prod.name}</div>
                          <div className={`${isDark ? 'text-slate-300' : 'text-slate-600'} text-sm`}>{formatCurrency(prod.pricePence)}</div>
                          <div className="mt-1 text-xs">{(prod.tags||[]).map(tag => <span key={tag} className={`inline-block mr-1 px-2 py-0.5 rounded text-xs ${isDark ? 'bg-slate-600 text-slate-200' : 'bg-slate-100 text-slate-600'}`}>{tag}</span>)}</div>
                        </div>
                        <div className={`${isDark ? 'text-slate-200' : 'text-slate-600'}`}><i className="fas fa-plus-circle"></i></div>
                      </div>
                    ))}
                  </div>

                  <div className="mt-4">
                    <h4 className={`${isDark ? 'text-white' : 'text-slate-800'} font-semibold mb-2`}>Current items</h4>
                    {orderItems.length === 0 ? (
                      <div className={`${isDark ? 'text-slate-300' : 'text-slate-600'}`}>No items yet. Tap a product to add.</div>
                    ) : (
                      <div className="space-y-2">
                        {orderItems.map(it => (
                          <div key={it.productId} className={`${isDark ? 'bg-slate-700' : 'bg-white'} p-2 rounded-lg flex items-center gap-3 card-shadow`}>
                            <div className="w-10 h-10 rounded bg-slate-600 flex items-center justify-center text-sm font-semibold text-white">{it.name.split(' ').map(s=>s[0]).join('')}</div>
                            <div className="flex-1">
                              <div className={`${isDark ? 'text-white' : 'text-slate-800'} font-medium`}>{it.name}</div>
                              <div className={`${isDark ? 'text-slate-300' : 'text-slate-600'} text-sm`}>{formatCurrency(it.pricePence)} Ã— {it.qty} = <span className="font-semibold">{formatCurrency(it.pricePence * it.qty)}</span></div>
                            </div>
                            <div className="flex items-center gap-2">
                              <button onClick={() => updateQty(it.productId, it.qty - 1)} className="px-2 py-1 rounded bg-slate-600 text-white">âˆ’</button>
                              <input type="number" value={it.qty} min="1" onChange={(e)=>updateQty(it.productId, Math.max(1, parseInt(e.target.value || 1)))} className="w-14 px-2 py-1 rounded bg-slate-800 text-white text-center" />
                              <button onClick={() => updateQty(it.productId, it.qty + 1)} className="px-2 py-1 rounded bg-emerald-600 text-white">+</button>
                              <button onClick={() => removeItem(it.productId)} className="px-2 py-1 rounded bg-rose-600 text-white"><i className="fas fa-trash"></i></button>
                            </div>
                          </div>
                        ))}
                      </div>
                    )}
                  </div>

                  <div className="flex gap-3 mt-4">
                    <button onClick={() => setStep(1)} className="px-4 py-2 rounded-lg bg-slate-700 text-white">Back</button>

                    {/* Done Editing when editing items */}
                    {editingPart === 'items' && editingOrderId ? (
                      <button onClick={() => doneEditing()} className="px-4 py-2 rounded-lg bg-emerald-600 text-white font-semibold">Done Editing</button>
                    ) : (
                      <button onClick={() => setStep(3)} className="px-4 py-2 rounded-lg bg-indigo-600 text-white font-semibold">Next: Time</button>
                    )}

                    <button onClick={() => { setOrderItems([]); showToast('Order items cleared'); }} className="ml-auto px-4 py-2 rounded-lg bg-rose-600 text-white">Clear Items</button>
                  </div>
                </div>
              )}

              {/* Step 3: native time picker */}
              {step === 3 && (
                <div className="mt-3">
                  <label className={`block ${isDark ? 'text-slate-200' : 'text-slate-700'} font-medium`}>Preferred {orderType === 'delivery' ? 'delivery' : 'collection'} time</label>
                  <div className="mt-2">
                    <input type="time" step="900" value={orderTime} onChange={(e)=>setOrderTime(e.target.value)} className={`px-3 py-2 rounded-lg ${isDark ? 'bg-slate-700 text-white' : 'bg-white text-slate-800'} border ${isDark ? 'border-slate-600' : 'border-slate-200'}`} />
                  </div>
                  <div className={`${isDark ? 'text-slate-300' : 'text-slate-600'} text-sm mt-2`}>Choose a time (minutes fixed to 15-minute intervals)</div>

                  <div className="flex gap-3 mt-4">
                    <button onClick={() => setStep(2)} className="px-4 py-2 rounded-lg bg-slate-700 text-white">Back</button>

                    {/* Done Editing when editing time */}
                    {editingPart === 'time' && editingOrderId ? (
                      <button onClick={() => doneEditing()} className="px-4 py-2 rounded-lg bg-emerald-600 text-white font-semibold">Done Editing</button>
                    ) : (
                      <button onClick={() => setStep(4)} className="px-4 py-2 rounded-lg bg-indigo-600 text-white font-semibold">Next: Customer</button>
                    )}

                    <button onClick={() => { setOrderTime(''); showToast('Time cleared'); }} className="ml-auto px-4 py-2 rounded-lg bg-rose-600 text-white">Clear Time</button>
                  </div>
                </div>
              )}

              {/* Step 4: Customer info */}
              {step === 4 && (
                <div className="mt-3 space-y-3">
                  <label className={`block ${isDark ? 'text-slate-200' : 'text-slate-700'} font-medium`}>Customer name</label>
                  <input value={customer.name} onChange={(e)=>setCustomer(c=>({...c, name:e.target.value}))} className={`w-full px-3 py-2 rounded-lg ${isDark ? 'bg-slate-700 text-white' : 'bg-white text-slate-800'} border ${isDark ? 'border-slate-600' : 'border-slate-200'}`} placeholder="e.g. John Smith" />

                  {orderType === 'delivery' && (
                    <>
                      <label className={`block ${isDark ? 'text-slate-200' : 'text-slate-700'} font-medium`}>Address</label>
                      <input value={customer.address} onChange={(e)=>setCustomer(c=>({...c, address:e.target.value}))} className={`w-full px-3 py-2 rounded-lg ${isDark ? 'bg-slate-700 text-white' : 'bg-white text-slate-800'} border ${isDark ? 'border-slate-600' : 'border-slate-200'}`} placeholder="House number and street" />
                      <div className="grid grid-cols-2 gap-3">
                        <input value={customer.postcode} onChange={(e)=>setCustomer(c=>({...c, postcode:e.target.value}))} placeholder="Postcode" className={`px-3 py-2 rounded-lg ${isDark ? 'bg-slate-700 text-white' : 'bg-white text-slate-800'} border ${isDark ? 'border-slate-600' : 'border-slate-200'}`} />
                        <input value={customer.phone} onChange={(e)=>setCustomer(c=>({...c, phone:e.target.value}))} placeholder="Phone (optional)" className={`px-3 py-2 rounded-lg ${isDark ? 'bg-slate-700 text-white' : 'bg-white text-slate-800'} border ${isDark ? 'border-slate-600' : 'border-slate-200'}`} />
                      </div>
                    </>
                  )}

                  <div className="flex gap-3 mt-4">
                    <button onClick={() => setStep(3)} className="px-4 py-2 rounded-lg bg-slate-700 text-white">Back</button>

                   {/* Done Editing when editing customer */}
{editingPart === 'customer' && editingOrderId ? (
  <button
    onClick={() => doneEditing()}
    className="px-4 py-2 rounded-lg bg-emerald-600 text-white font-semibold"
  >
    Done Editing
  </button>
) : (
  <button
    onClick={() => setStep(5)}
    className="px-4 py-2 rounded-lg bg-indigo-600 text-white font-semibold"
  >
    Next: Review
  </button>
)}
</div>
</div>
)}



              {/* Step 5: Review */}
              {step === 5 && (
                <div className="mt-3">
                  <div className={`${isDark ? 'bg-slate-700' : 'bg-white'} rounded-lg p-4`}>
                    <div className="flex items-start justify-between">
                      <div>
                        <div className={`${isDark ? 'text-slate-300' : 'text-slate-600'}`}>Order Type</div>
                        <div className={`${isDark ? 'text-white' : 'text-slate-800'} font-semibold`}>{orderType ? orderType.charAt(0).toUpperCase() + orderType.slice(1) : 'â€”'}</div>
                      </div>
                      <div>
                        <div className={`${isDark ? 'text-slate-300' : 'text-slate-600'}`}>Time</div>
                        <div className={`${isDark ? 'text-white' : 'text-slate-800'} font-semibold`}>{orderTime || 'â€”'}</div>
                      </div>
                    </div>

                    <div className="mt-4">
                      <h4 className={`${isDark ? 'text-white' : 'text-slate-800'} font-semibold`}>Customer</h4>
                      <div className={`${isDark ? 'text-slate-200' : 'text-slate-600'} mt-2`}>
                        <div>{customer.name || 'â€”'}</div>
                        {orderType === 'delivery' && <div className={`${isDark ? 'text-slate-300' : 'text-slate-500'} mt-1`}>{customer.address || 'â€”'} â€¢ {customer.postcode || 'â€”'} {customer.phone ? `â€¢ ${customer.phone}` : ''}</div>}
                      </div>
                    </div>

                    <div className="mt-4">
                      <h4 className={`${isDark ? 'text-white' : 'text-slate-800'} font-semibold`}>Items</h4>
                      <div className="mt-2 space-y-2">
                        {orderItems.map(it=>(
                          <div key={it.productId} className="flex justify-between items-center">
                            <div className={`${isDark ? 'text-slate-100' : 'text-slate-800'}`}>{it.name} Ã— {it.qty}</div>
                            <div className={`${isDark ? 'text-slate-200' : 'text-slate-600'}`}>{formatCurrency(it.pricePence * it.qty)}</div>
                          </div>
                        ))}
                      </div>
                      <div className="mt-3 border-t border-slate-700 pt-3 flex justify-between font-semibold">
                        <div>Grand Total</div>
                        <div>{formatCurrency(grandTotalPence)}</div>
                      </div>
                    </div>

                    <div className="flex gap-3 mt-4">
                      <button onClick={() => setStep(4)} className="px-4 py-2 rounded-lg bg-slate-700 text-white">Back</button>
                      <button onClick={() => saveOrder()} className="px-4 py-2 rounded-lg bg-emerald-600 text-white font-semibold">Confirm & Save Order</button>
                      <button onClick={() => clearActiveOrder()} className="ml-auto px-4 py-2 rounded-lg bg-rose-600 text-white">Start New Order</button>
                    </div>
                  </div>
                </div>
              )}
            </div>
          </div>
        </section>

        {/* RIGHT: History / summary / reset */}
        <aside className="md:col-span-1 space-y-4">
          <div className={`${isDark ? 'bg-slate-800' : 'bg-white'} rounded-2xl p-4 card-shadow`}>
            <div className="flex items-center justify-between">
              <div>
                <div className={`${isDark ? 'text-slate-300' : 'text-slate-600'} text-sm`}>Current Order</div>
                <div className={`${isDark ? 'text-white' : 'text-slate-800'} text-lg font-semibold`}>{orderType ? orderType.toUpperCase() : 'â€”'}</div>
              </div>
              <div className="text-right">
                <div className={`${isDark ? 'text-slate-300' : 'text-slate-600'} text-sm`}>Items</div>
                <div className="font-semibold">{totalItems}</div>
              </div>
            </div>

            <div className="mt-4">
              <div className={`${isDark ? 'text-slate-300' : 'text-slate-600'} text-sm`}>Grand total</div>
              <div className={`text-2xl font-extrabold mt-1 ${isDark ? 'text-white' : 'text-slate-800'}`}>{formatCurrency(grandTotalPence)}</div>
            </div>

            <div className="mt-4 flex gap-2">
              
              <button onClick={confirmResetDay} className="px-3 py-2 rounded-lg bg-rose-600 text-white">Reset Day</button>
            </div>
          </div>

          {/* Pending / Completed */}
          <div className={`${isDark ? 'bg-slate-800' : 'bg-white'} rounded-xl p-3 card-shadow`}>
            <div className="flex items-center justify-between mb-3">
              <h4 className={`${isDark ? 'text-white' : 'text-slate-800'} font-semibold`}>Orders</h4>
              <div className="text-sm">
                <span className="font-medium">{orders.filter(o=>o.status==='pending').length}</span> pending
              </div>
            </div>

            <div className="space-y-2 max-h-52 overflow-auto">
              {orders.filter(o=>o.status==='pending').length === 0 && <div className={`${isDark ? 'text-slate-300' : 'text-slate-600'}`}>No pending orders</div>}
              {orders.filter(o=>o.status==='pending').map(o => (
                <div key={o.id} className={`${isDark ? 'bg-slate-700' : 'bg-slate-50'} p-2 rounded-lg flex items-start justify-between`}>
                  <div>
                    <div className={`${isDark ? 'text-white' : 'text-slate-800'} font-medium`}>{o.customer.name || 'No name'}</div>
                    <div className={`${isDark ? 'text-slate-300' : 'text-slate-600'} text-sm`}>{o.type} â€¢ {o.time} â€¢ {formatCurrency(o.totalPence)}</div>
                    <div className={`text-slate-300 text-sm mt-1`}>{o.items.map(i=>`${i.qty}Ã—${i.name}`).join(', ')}</div>
                  </div>
                  <div className="flex flex-col gap-2">
                    <button onClick={()=>beginView(o.id)} className="px-2 py-1 rounded bg-indigo-600 text-white text-sm">View</button>
<button onClick={()=>markComplete(o.id)} className="px-2 py-1 rounded bg-emerald-600 text-white text-sm">Complete</button>

                  </div>
                </div>
              ))}
            </div>

            <div className="mt-3 border-t pt-3">
              <button onClick={()=>setShowCompleted(c=>!c)} className="text-sm text-slate-300">{showCompleted ? 'Hide' : 'Show'} Completed Orders ({orders.filter(o=>o.status==='completed').length})</button>
            </div>

            {showCompleted && (
              <div className="mt-3 space-y-2 max-h-40 overflow-auto">
                {orders.filter(o=>o.status==='completed').length === 0 && <div className="text-slate-400">No completed orders</div>}
                {orders.filter(o=>o.status==='completed').map(o => (
                  <div key={o.id} className={`${isDark ? 'bg-slate-700' : 'bg-slate-50'} p-2 rounded-lg flex items-start justify-between`}>
                    <div>
                      <div className={`${isDark ? 'text-white' : 'text-slate-800'} font-medium`}>{o.customer.name || 'No name'}</div>
                      <div className={`${isDark ? 'text-slate-300' : 'text-slate-600'} text-sm`}>{o.type} â€¢ {o.time} â€¢ {formatCurrency(o.totalPence)}</div>
                    </div>
                    <div className="flex flex-col gap-2">
                      <button onClick={()=>reopenOrder(o.id)} className="px-2 py-1 rounded bg-slate-600 text-white text-sm">Reopen</button>
                      <button onClick={()=>deleteOrder(o.id)} className="px-2 py-1 rounded bg-rose-600 text-white text-sm">Delete</button>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>

          

        </aside>
      </main>

      {/* Edit choice modal */}
      <Modal open={editChoiceModalOpen} title="Edit order" onClose={() => { setEditChoiceModalOpen(false); setEditingOrderId(null); }}>
        <div>
          <p className="mb-3">Which part would you like to edit?</p>
          <div className="flex gap-2">
            <button onClick={() => chooseEditPart('items')} className="px-3 py-2 rounded bg-indigo-600 text-white">Items</button>
            <button onClick={() => chooseEditPart('time')} className="px-3 py-2 rounded bg-amber-500 text-white">Time</button>
            <button onClick={() => chooseEditPart('customer')} className="px-3 py-2 rounded bg-emerald-600 text-white">Customer Info</button>
            <button onClick={() => { setEditChoiceModalOpen(false); setEditingOrderId(null); }} className="px-3 py-2 rounded bg-slate-700 text-white">Cancel</button>
          </div>
        </div>
      </Modal>

{/* View Order modal */}
<Modal open={viewModalOpen} title="View Order" onClose={() => { setViewModalOpen(false); setViewingOrder(null); }}>
  {viewingOrder && (
    <div>
      <p className="mb-2 font-semibold">{viewingOrder.customer.name}</p>
      <p className="text-sm mb-2">{viewingOrder.type.toUpperCase()} â€¢ {viewingOrder.time}</p>
      <div className="mb-2">
        {viewingOrder.items.map(it => (
          <div key={it.name} className="flex justify-between text-sm">
            <div>{it.name} Ã— {it.qty}</div>
            <div>{formatCurrency(it.pricePence * it.qty)}</div>
          </div>
        ))}
      </div>
      <div className="font-semibold border-t pt-2 mb-3">Total: {formatCurrency(viewingOrder.totalPence)}</div>
      <div className="flex gap-2">
        <button
  onClick={() => {
    const { jsPDF } = window.jspdf;

    // 58mm width, 65mm height per page
    const doc = new jsPDF({
      orientation: "portrait",
      unit: "mm",
      format: [58, 65],
    });

    const pageHeight = 65;
    const lineHeight = 4; // slightly tighter spacing
    let y = 8;

    const addLine = (text = "", size = 8, bold = false) => {
      doc.setFontSize(size);
      doc.setFont("courier", bold ? "bold" : "normal"); // neat monospace look
      if (y > pageHeight - 8) {
        doc.addPage([58, 65], "portrait");
        y = 8;
      }
      doc.text(text, 4, y);
      y += lineHeight;
    };

    // ---- HEADER ----
    addLine("Fish & Chips Shop", 9, true);
    addLine("------------------------------");
    addLine(`Order Type: ${viewingOrder.type}`);
    addLine(`Time: ${viewingOrder.time}`);
    addLine(`Customer: ${viewingOrder.customer.name}`);
    addLine("------------------------------");

    // ---- ITEMS (no prices) ----
    viewingOrder.items.forEach((it) => {
      addLine(`${it.name}  x${it.qty}`);
    });

    // ---- TOTAL ----
    addLine("------------------------------");
    addLine(`Total: Â£${(viewingOrder.totalPence / 100).toFixed(2)}`, 9, true);
    addLine("------------------------------");
    addLine(new Date().toLocaleString(), 7);
    addLine("Thank you!", 8, true);

    // ---- DELIVERY ADDRESS (on separate last page) ----
    if (viewingOrder.type === "delivery") {
      doc.addPage([58, 65], "portrait");
      let y2 = 12;
      const addAddr = (txt, size = 8, bold = false) => {
        doc.setFontSize(size);
        doc.setFont("courier", bold ? "bold" : "normal");
        doc.text(txt, 4, y2);
        y2 += 5;
      };
      addAddr("Delivery Address", 9, true);
      addAddr("------------------------------");
      addAddr(viewingOrder.customer.name);
      addAddr(viewingOrder.customer.address);
      addAddr(viewingOrder.customer.postcode);
      if (viewingOrder.customer.phone)
        addAddr(`Phone: ${viewingOrder.customer.phone}`);
    }

    // ---- SAVE FILE ----
    doc.save(`order_${viewingOrder.customer.name || "customer"}.pdf`);
  }}
  className="px-4 py-2 rounded bg-slate-700 text-white font-semibold"
>
  Download PDF Receipt
</button>



        <button
          onClick={() => {
            setViewModalOpen(false);
            setEditingOrderId(viewingOrder.id);
            setEditChoiceModalOpen(true);
          }}
          className="px-4 py-2 rounded bg-indigo-600 text-white font-semibold"
        >
          Edit / View Details
        </button>
      </div>
    </div>
  )}
</Modal>

      {/* Item add modal */}
      <Modal open={!!showItemModal} title={showItemModal ? `Add ${showItemModal.name}` : ''} onClose={()=>setShowItemModal(null)}>
        {showItemModal && <AddItemForm product={showItemModal} onCancel={()=>setShowItemModal(null)} onAdd={(qty)=>{ addOrUpdateItem(showItemModal, qty); setShowItemModal(null); }} />}
      </Modal>

      {/* Reset day modal */}
      <Modal open={resetModalOpen} title="Reset day?" onClose={()=>setResetModalOpen(false)}>
        <div>
          <p>Are you sure you want to reset the day? This will clear all pending and completed orders.</p>
          <div className="mt-4 flex gap-2">
            <button onClick={()=>setResetModalOpen(false)} className="px-4 py-2 rounded bg-slate-700 text-white">Cancel</button>
            <button onClick={()=>doResetDay()} className="px-4 py-2 rounded bg-rose-600 text-white">Reset Day</button>
          </div>
        </div>
      </Modal>

      {/* New order confirm modal (red accent) */}
      <Modal open={newOrderConfirmOpen} title="Start a new order?" onClose={cancelStartNew}>
        <div>
          <p>This will clear your current order in progress.</p>
          <div className="mt-4 flex gap-2">
            <button onClick={cancelStartNew} className="px-4 py-2 rounded bg-slate-700 text-white">Cancel</button>
            <button onClick={confirmStartNew} className="px-4 py-2 rounded bg-rose-600 text-white">Start New</button>
          </div>
        </div>
      </Modal>

      <Toast open={toast.open} text={toast.text} actionLabel={toast.action ? 'Undo' : null} onAction={toast.action ? (() => { if (toast.action) toast.action(); setToast({ open:false, text:'', action:null }); }) : null} />

    </div>
  );
}

/* ---------- AddItemForm ---------- */
function AddItemForm({ product, onCancel, onAdd }) {
  const [qty, setQty] = useState(1);
  const inc = () => setQty(q => q + 1);
  const dec = () => setQty(q => Math.max(1, q - 1));
  return (
    <div>
      <div className="flex items-center gap-4">
        <div className="w-16 h-16 rounded-lg bg-slate-700 flex items-center justify-center text-white text-xl font-bold">{product.name.split(' ').slice(0,2).map(w=>w[0]).join('')}</div>
        <div>
          <div className="font-semibold text-slate-900 dark:text-slate-100">{product.name}</div>
          <div className="text-slate-500 dark:text-slate-300">{formatCurrency(product.pricePence)}</div>
        </div>
      </div>

      <div className="mt-4 flex items-center gap-3">
        <button onClick={dec} className="px-3 py-2 rounded bg-slate-600 text-white text-lg">âˆ’</button>
        <input type="number" min="1" value={qty} onChange={(e)=>setQty(Math.max(1, parseInt(e.target.value || 1)))} className="w-20 px-2 py-2 rounded bg-white/5 text-black text-center" />
        <button onClick={inc} className="px-3 py-2 rounded bg-emerald-600 text-white text-lg">+</button>
      </div>

      <div className="mt-4 flex gap-2">
        <button onClick={onCancel} className="px-4 py-2 rounded-lg bg-slate-700 text-white">Cancel</button>
        <button onClick={()=>onAdd(qty)} className="px-4 py-2 rounded-lg bg-emerald-600 text-white font-semibold">Add {qty}</button>
      </div>
    </div>
  );
}

/* ---------- Render ---------- */
ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
